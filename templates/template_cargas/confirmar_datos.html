<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Confirmar Datos Extra√≠dos - NUAM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --naranja-oscuro: #D35400;
            --naranja: #E67E22;
            --naranja-claro: #F39C12;
            --blanco: #FFFFFF;
            --gris-claro: #F8F9FA;
            --texto-oscuro: #2C3E50;
        }
        
        body { 
            background-color: var(--gris-claro); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-nuam {
            background: var(--naranja-oscuro) !important;
        }
        
        .card-dashboard {
            background: var(--blanco);
            border: none;
            border-radius: 12px;
            border-left: 4px solid var(--naranja-oscuro);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-nuam { 
            background-color: var(--naranja-oscuro); 
            border: none; 
            color: white; 
            font-weight: 600;
        }
        
        .btn-nuam:hover { 
            background-color: var(--naranja); 
        }
        
        .btn-outline-nuam { 
            border: 1px solid var(--naranja-oscuro); 
            color: var(--naranja-oscuro); 
            font-weight: 600;
        }
        
        .btn-outline-nuam:hover { 
            background-color: var(--naranja-oscuro); 
            color: white; 
        }
        
        .welcome-section {
            background: var(--naranja-oscuro);
            color: white;
            border-radius: 12px;
            padding: 2rem;
        }
        
        .table-custom {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .table-custom thead {
            background-color: var(--naranja-oscuro);
            color: white;
        }
        
        .table-custom th {
            border: none;
            font-weight: 600;
            padding: 1rem;
        }
        
        .table-custom td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .badge-market {
            background-color: rgba(211, 84, 0, 0.1);
            color: var(--naranja-oscuro);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        
        .data-preview {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .checkbox-cell {
            width: 50px;
            text-align: center;
        }
        
        .summary-card {
            background: var(--blanco);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--naranja-oscuro);
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-nuam">
    <div class="container-fluid">
        <span class="navbar-brand text-white">NUAM - Confirmar Datos</span>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text text-white me-3">
                {{ request.session.usuario_nombre }}
            </span>
            <a href="{% url 'extraer_datos_pdf' %}" class="btn btn-sm btn-outline-light me-2">
                ‚Üê Subir otro PDF
            </a>
            <a href="{% url 'dashboard_corredor' %}" class="btn btn-sm btn-outline-light me-2">
                üìä Dashboard
            </a>
            <a href="{% url 'logout' %}" class="btn btn-sm btn-outline-light">Cerrar Sesi√≥n</a>
        </div>
    </div>
</nav>

<div class="container-fluid py-4">

    <div class="row mb-4">
        <div class="col">
            <div class="welcome-section">
                <h1 class="display-6">Datos Extra√≠dos del PDF</h1>
                <p class="mb-0">Selecciona los datos que quieres guardar en el sistema</p>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="summary-card">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <h3 style="color: var(--naranja-oscuro);">{{ datos_extraidos|length }}</h3>
                        <p>Registros Encontrados</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3 style="color: var(--naranja-oscuro);">{{ nombre_archivo }}</h3>
                        <p>Archivo PDF</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3 style="color: var(--naranja-oscuro);">{{ corredor.nombre }}</h3>
                        <p>Corredor</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if datos_extraidos %}
    <div class="card card-dashboard">
        <div class="card-header d-flex justify-content-between align-items-center" style="background: var(--naranja-oscuro); color: white;">
            <h5 class="mb-0">Seleccionar Datos para Guardar</h5>
            <small>{{ datos_extraidos|length }} registros detectados</small>
        </div>

        <form method="POST" action="{% url 'guardar_datos_pdf' %}">
            {% csrf_token %}

            <div class="data-preview">
                <table class="table table-hover table-custom mb-0">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAll" checked>
                            </th>
                            <th>Fecha</th>
                            <th>Mercado</th>
                            <th>A√±o</th>
                            <th>Factor/Monto</th>
                            <th>Descripci√≥n</th>
                            <th>P√°gina</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for dato in datos_extraidos %}
                        <tr>
                            <td class="checkbox-cell">
                                <input type="checkbox" name="datos_seleccionados" value="{{ forloop.counter0 }}" checked>
                            </td>

                            <td>
                                {% if dato.fechas %}
                                    <small>{{ dato.fechas.0 }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <td>
                                {% if dato.mercados %}
                                    <span class="badge-market">{{ dato.mercados.0 }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <td>
                                {% if dato.anos %}
                                    <span class="badge bg-secondary">{{ dato.anos.0 }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <td>
                                {% if dato.factores %}
                                    <span class="badge bg-warning text-dark">{{ dato.factores.0 }}</span>
                                {% elif dato.montos %}
                                    <span class="badge bg-info text-dark">{{ dato.montos.0 }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <td>
                                <small>{{ dato.texto_completo|default:"Extra√≠do de PDF" }}</small>
                            </td>

                            <td>
                                <span class="badge bg-light text-dark">P√°g {{ dato.pagina }}</span>
                            </td>
                        </tr>

                        <!-- Hidden Fields -->
                        <input type="hidden" name="fecha_{{ forloop.counter0 }}" value="{{ dato.fechas.0|default:'' }}">
                        <input type="hidden" name="mercado_{{ forloop.counter0 }}" value="{{ dato.mercados.0|default:'' }}">
                        <input type="hidden" name="ano_{{ forloop.counter0 }}" value="{{ dato.anos.0|default:'' }}">
                        <input type="hidden" name="factor_{{ forloop.counter0 }}" value="{{ dato.factores.0|default:'' }}">
                        <input type="hidden" name="descripcion_{{ forloop.counter0 }}" value="{{ dato.texto_completo|default:'Extra√≠do de PDF' }}">

                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card-footer d-flex justify-content-between">
                <div><strong id="selectedCount">{{ datos_extraidos|length }}</strong> registros seleccionados</div>

                <div>
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="deselectAll()">Deseleccionar Todos</button>
                    <button type="submit" class="btn btn-nuam">Guardar Datos Seleccionados</button>
                </div>
            </div>

        </form>
    </div>

    {% else %}
    <div class="text-center py-5">
        <h5 class="text-muted">No se encontraron datos en el PDF</h5>
        <a href="{% url 'extraer_datos_pdf' %}" class="btn btn-nuam">Procesar otro PDF</a>
    </div>
    {% endif %}

</div>

<script>
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="datos_seleccionados"]');
        checkboxes.forEach(c => c.checked = this.checked);
        updateSelectedCount();
    });

    function deselectAll() {
        document.getElementById('selectAll').checked = false;
        document.querySelectorAll('input[name="datos_seleccionados"]').forEach(c => c.checked = false);
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = document.querySelectorAll('input[name="datos_seleccionados"]:checked').length;
        document.getElementById('selectedCount').textContent = count;
    }
</script>

</body>
</html>
